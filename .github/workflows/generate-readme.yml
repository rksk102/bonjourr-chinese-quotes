name: "âœ¨ Auto-Generate README"

on:
  schedule:
    - cron: "30 0 * * *"
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if no changes?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: readme-updater
  cancel-in-progress: true

jobs:
  generator:
    name: ğŸš€ Generator Engine
    runs-on: ubuntu-latest
    env:
      term: xterm-256color
      PYTHONUNBUFFERED: "1"

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ” System Inspection
        run: |
          echo "::group::ğŸ› ï¸ Environment Info"
          echo "Run ID: $GITHUB_RUN_ID"
          echo "Actor: $GITHUB_ACTOR"
          python --version
          git --version
          echo "::endgroup::"

      - name: âš¡ Run Generator Script
        id: run_script
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          QUOTES_CSV: "quotes.csv"
        run: |
          # è¿è¡Œä¼˜åŒ–åçš„è„šæœ¬
          python scripts/generate_readme.py

      - name: ğŸ“Š Diff & Verify
        id: check_diff
        run: |
          echo "::group::ğŸ“„ Git Status & Diff"
          git status -s
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected in README.md"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Changes detected! Showing stats:"
            git diff --stat README.md
          fi
          echo "::endgroup::"

      - name: ğŸ’¾ Commit & Push
        if: steps.check_diff.outputs.changed == 'true' || inputs.force_run
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          echo "::group::ğŸš€ Pushing changes"
          git add README.md
          DATE_STR=$(date "+%Y-%m-%d")
          git commit -m "chore(doc): update stats & daily quote [$DATE_STR] [skip ci]"
          git push
          echo "::endgroup::"
          echo "âœ… Successfully pushed updates to repository."

      - name: ğŸš¨ Diagnostic Dump
        if: failure()
        run: |
          echo "::error::Workflow failed! Creating disaster dump..."
          echo "::group::ğŸ“‚ File Tree (Depth 3)"
          tree -L 3 . || find . -maxdepth 3
          echo "::endgroup::"
          
          echo "::group::ğŸ“„ CSV Head Check"
          head -n 5 quotes.csv || echo "CSV file is missing!"
          echo "::endgroup::"
