name: "ğŸ¦„ Update Quotes Daily"

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update_quotes:
    name: ğŸš€ Quote Engine
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.git_commit.outputs.changed }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ–¥ï¸ System Info
        run: |
          echo "::group::âš™ï¸ Environment Details"
          echo "System: $(uname -a)"
          echo "Python: $(python3 --version)"
          echo "Date: $(date)"
          echo "::endgroup::"
          
          echo -e "\033[36m"
          echo "============================================"
          echo "      âœ¨ DAILY QUOTES UPDATER v2.1 âœ¨       "
          echo "============================================"
          echo -e "\033[0m"

      - name: ğŸ Run Extraction Script
        id: run_script
        run: python scripts/update.py
        env:
          PYTHONIOENCODING: utf-8
          MAX_QUOTE_LENGTH: "15"

      - name: ğŸ“Š Verify Data Integrity
        if: success()
        run: |
          echo "::group::ğŸ” Data Inspection"
          if [ -f quotes.csv ]; then
            echo "âœ… quotes.csv exists."
            LINE_COUNT=$(wc -l < quotes.csv)
            echo "ğŸ“„ Total Lines: $LINE_COUNT"
            echo "ğŸ‘€ Head (First 3):"
            head -n 3 quotes.csv
          else
            echo "âŒ Fatal: quotes.csv is missing!"
            exit 1
          fi
          echo "::endgroup::"

      - name: ğŸ“¡ Commit & Push
        id: git_commit
        if: success()
        run: |
          echo "::group::ğŸ“ Git Operations"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add quotes.csv
          
          if git diff --staged --quiet; then
            echo "ğŸ¤” No changes detected. Skipping commit."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ğŸ“… [Auto] Quotes Update $(date +'%Y-%m-%d')"
            git push
            echo "ğŸš€ Changes pushed to repository successfully."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      - name: ğŸš¨ Error Handler
        if: failure()
        run: |
          echo -e "\033[31m"
          echo "============================================"
          echo "         ğŸš« WORKFLOW FAILED ğŸš«              "
          echo "============================================"
          echo "Check the 'Run Extraction Script' step above"
          echo "for detailed python tracebacks."
          echo -e "\033[0m"
